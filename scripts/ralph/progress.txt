# Ralph Progress Log
Started: Mon Feb 16 19:15:19 CST 2026
---

## Codebase Patterns

### Review Agent Pattern
- Each review agent is a function: `(context: ReviewContext) => Promise<AgentResult>`
- Refactoring agent has extra param: `(context, findings) => Promise<AgentResult>`
- AgentResult includes: agent name, success flag, markdown report, findings array, blockingIssues array
- FindingSeverity: critical | high | medium | low | info
- critical/high findings block epic advancement
- Review artifacts saved to `.boop/reviews/epic-N/` with specific filenames per agent
- QA smoke test results go in a subdirectory: `.boop/reviews/epic-N/qa-smoke-test/`

### Code Review Agent Pattern
- Factory function: `createCodeReviewer(options)` returns `ReviewAgentFn`
- Uses git diff to find changed files, reads diffs + content
- Batches files (50k chars max) for API calls
- Claude outputs structured JSON finding lines, parsed by `parseFindings()`
- Source files use relative imports (`../shared/`), NOT `#boop/` alias

### Gap Analyst Agent Pattern
- Factory function: `createGapAnalyst(options)` returns `ReviewAgentFn`
- Reads PRD from `.boop/prd.json`, extracts stories + acceptance criteria
- Scans source files for placeholder patterns (TODO, FIXME, mock, stub, etc.)
- Sends criteria + code to Claude, parses `{storyId, criterion, status, evidence}` JSON lines
- Gaps are high severity + blocking; placeholder matches are medium severity
- Uses `\bmock` (no trailing `\b`) to catch prefixed mock variables like `mockData`

### Tech Debt Auditor Pattern
- Factory function: `createTechDebtAuditor(options)` returns `ReviewAgentFn`
- Collects source files recursively from `src/` (same skip dirs as gap-analyst)
- Sends full file contents to Claude for tech debt analysis (duplication, coupling, naming, unused code)
- Uses same JSON-line parsing as code-reviewer (`parseFindings()`)
- critical/high findings become blockingIssues

### Refactoring Agent Pattern
- Factory function: `createRefactoringAgent(options)` returns `RefactoringAgentFn`
- Receives combined findings from parallel phase (code-reviewer + gap-analyst + tech-debt-auditor)
- Reads only affected files referenced in findings (not entire codebase)
- Groups findings by severity (critical first) in prompt
- Uses same JSON-line parsing for fix suggestions
- Commits should use format: `refactor: Epic N review - [description]`

### Review Pipeline Sequence
1. Parallel: code-reviewer + gap-analyst + tech-debt-auditor (Promise.all)
2. refactoring-agent (receives combined findings from step 1)
3. test-hardener
4. test-suite run (if fails, pipeline stops — skips security + QA)
5. security-scanner
6. qa-smoke-test

---

## 2026-02-16 19:20 - Story 5.1
- Implemented review team orchestrator at src/review/team-orchestrator.ts
- Files created:
  - src/review/team-orchestrator.ts (orchestrator + types + error class)
  - src/review/team-orchestrator.test.ts (35 tests)
- **Learnings for future iterations:**
  - Agent functions are injected via options for testability — no vi.mock needed
  - ReviewPhaseError follows same pattern as PlanningPhaseError
  - Test suite failure is an early-exit condition — stops before security/QA
  - Blocking conditions: unresolved gaps, critical/high vulns, QA crashes, test failures
  - vi.fn<FnType>() typing works well for typed mock agents
---

## 2026-02-16 19:25 - Story 5.2
- Implemented code review agent at src/review/code-reviewer.ts
- Files created:
  - src/review/code-reviewer.ts (code reviewer agent with git diff + Claude review)
  - src/review/code-reviewer.test.ts (26 tests)
- **Architecture:**
  - `createCodeReviewer(options)` factory returns a `ReviewAgentFn`
  - Uses `git diff --name-only --diff-filter=ACMR` to find changed files
  - Batches files by size (50k chars) for API calls to avoid token limits
  - Sends diffs + content to Claude with structured JSON output format
  - `parseFindings()` parses JSON lines from response
  - critical/high findings become blockingIssues
  - Falls back to `git ls-files` if diff against base branch fails
- **Learnings for future iterations:**
  - Source files must use relative imports (`../shared/`), NOT `#boop/` alias — alias only works in vitest
  - When mocking `node:child_process.execFile` with promisify, must also mock `node:util.promisify`
  - Git diff args include `--diff-filter=ACMR` at index 2, so matching by branch name needs `args.includes()` not positional check
  - Truncation helper needed for large files to stay within API token limits
---

## 2026-02-16 19:30 - Story 5.3
- Implemented gap analysis agent at src/review/gap-analyst.ts
- Files created:
  - src/review/gap-analyst.ts (gap analyst agent with PRD cross-reference + placeholder scan)
  - src/review/gap-analyst.test.ts (37 tests)
- **Architecture:**
  - `createGapAnalyst(options)` factory returns a `ReviewAgentFn`
  - Reads stories from `.boop/prd.json` — extracts acceptance criteria
  - Recursively collects source files from `src/` (skips node_modules, .git, dist, test, .boop)
  - Scans production code for placeholder patterns: TODO, FIXME, HACK, stub, fake, mock, placeholder, dummy, sample, hardcoded, not implemented
  - Sends criteria + source code to Claude for intelligent gap verification
  - Claude outputs structured JSON: `{storyId, criterion, status: verified|gap, evidence}`
  - `parseCriterionResults()` parses JSON lines from response
  - Gaps become high-severity findings + blocking issues
  - Placeholder matches become medium-severity findings
  - Requests 8192 maxTokens (more than default 4096) for detailed analysis
- **Learnings for future iterations:**
  - `\bmock\b` regex won't match `mockData` — use `\bmock` (no trailing boundary) to catch prefixed mock variables
  - `readPrdStories()` handles missing/invalid PRD gracefully — returns empty array
  - `collectSourceFiles()` uses `fs.readdirSync({ withFileTypes: true })` for efficient recursive traversal
  - `maxFilesForApi` and `maxTotalChars` limits prevent API token overflow on large codebases
  - Test pattern: write PRD + source files to tmpDir, mock sendMessage, verify message content + result structure
---

## 2026-02-16 19:35 - Story 5.4
- Implemented tech debt auditor at src/review/tech-debt-auditor.ts
- Implemented refactoring agent at src/review/refactoring-agent.ts
- Files created:
  - src/review/tech-debt-auditor.ts (tech debt auditor agent — scans codebase via Claude SDK)
  - src/review/tech-debt-auditor.test.ts (25 tests)
  - src/review/refactoring-agent.ts (refactoring agent — takes combined findings, suggests fixes via Claude SDK)
  - src/review/refactoring-agent.test.ts (24 tests)
- **Architecture:**
  - `createTechDebtAuditor(options)` factory returns `ReviewAgentFn` — runs in parallel with code-reviewer and gap-analyst
  - Collects source files recursively, sends to Claude for analysis (duplication, coupling, naming, unused code)
  - `createRefactoringAgent(options)` factory returns `RefactoringAgentFn` — runs AFTER parallel phase
  - Receives combined findings, reads affected files, sends to Claude for fix suggestions
  - Groups findings by severity (critical first) in the prompt for prioritized fixing
  - Both agents use same JSON-line parsing pattern as code-reviewer/gap-analyst
  - Both request 8192 maxTokens for detailed analysis
- **Learnings for future iterations:**
  - `getAffectedFiles()` deduplicates file paths from findings — prevents sending same file content multiple times
  - Refactoring agent only reads files referenced in findings (not entire codebase) — more focused API calls
  - SCAN_EXTENSIONS filter applied to affected files prevents reading non-code files (README.md, etc.)
  - Both agents share the same parseFindings/extractSummary pattern — potential future extraction to shared module
  - Test helper `makeFindings()` simplifies creating test finding arrays with defaults
---
