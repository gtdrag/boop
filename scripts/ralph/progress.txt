# Ralph Progress Log
Started: Mon Feb 16 16:38:33 CST 2026

## Codebase Patterns
- Use `vi.hoisted()` for mock functions referenced inside `vi.mock()` factory — `const` declarations at module level are NOT available inside hoisted vi.mock factories
- Use `mockFn.mockReset()` in `beforeEach` instead of `vi.restoreAllMocks()` in afterEach — restoreAllMocks removes mock implementations from vi.mock factories
- Anthropic SDK `APIError` constructor requires a `Headers` object (use `new Headers()`) — plain `{}` causes `headers?.get is not a function`
- Mock `@clack/prompts` in CLI tests when testing code paths that call interactive prompts (select, confirm, text) to avoid hanging tests
- `import.meta.dirname` works in vitest for resolving paths relative to the source file
---

## 2026-02-16 - Story 3.1: Viability assessment
- What was implemented:
  - Added `@anthropic-ai/sdk` dependency (v0.74.0) for Claude API integration
  - Created `src/shared/claude-client.ts` — shared Claude API client with `sendMessage()`, `createAnthropicClient()`, and `isRetryableApiError()` (rate limit + server errors are retryable)
  - Created `prompts/viability/system.md` — BMAD-style prompt template for viability assessment (feasibility, market fit, technical complexity)
  - Created `src/planning/viability.ts` — viability assessment module with profile context formatting, recommendation extraction (PROCEED/CONCERNS/RECONSIDER), and file persistence to `.boop/planning/viability.md`
  - Updated `src/cli/program.ts` — `boop <idea>` now runs viability assessment, displays results, and prompts user to proceed/revise/stop
  - Created `src/shared/claude-client.test.ts` — 7 tests for API error classification
  - Created `src/planning/viability.test.ts` — 20 tests covering prompt loading, profile formatting, recommendation extraction, file saving, and mocked API calls
  - Updated `src/cli/program.test.ts` — added viability and @clack/prompts mocks to prevent real API calls and interactive prompt hangs
- Files changed:
  - NEW: `src/shared/claude-client.ts`, `src/shared/claude-client.test.ts`
  - NEW: `src/planning/viability.ts`, `src/planning/viability.test.ts`
  - NEW: `prompts/viability/system.md`
  - MODIFIED: `package.json`, `pnpm-lock.yaml` (@anthropic-ai/sdk)
  - MODIFIED: `src/shared/index.ts` (re-exports claude-client)
  - MODIFIED: `src/cli/program.ts`, `src/cli/program.test.ts` (viability integration + mocks)
  - FORMATTING: docs/epics.md, src/config/index.ts, src/pipeline/orchestrator.test.ts, src/profile/*.ts, src/shared/*.ts (oxfmt)
- **Learnings for future iterations:**
  - vi.mock() factories are hoisted to the top of the file — any variables referenced inside must use `vi.hoisted()` to be available
  - vi.restoreAllMocks() removes mock implementations from vi.mock factories — use mockReset() on individual mocks instead
  - Anthropic SDK APIError needs a Headers object, not a plain object
  - CLI tests that trigger startPipeline need @clack/prompts mocked to avoid interactive prompt hangs
  - The retry utility integrates cleanly with isRetryableApiError for Claude API fault tolerance
  - prompts/ directory is not in tsconfig include — markdown files are loaded at runtime via fs.readFileSync
---
