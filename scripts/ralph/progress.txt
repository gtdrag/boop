# Ralph Progress Log
Started: Mon Feb 16 16:38:33 CST 2026

## Codebase Patterns
- Use `vi.hoisted()` for mock functions referenced inside `vi.mock()` factory — `const` declarations at module level are NOT available inside hoisted vi.mock factories
- Use `mockFn.mockReset()` in `beforeEach` instead of `vi.restoreAllMocks()` in afterEach — restoreAllMocks removes mock implementations from vi.mock factories
- Anthropic SDK `APIError` constructor requires a `Headers` object (use `new Headers()`) — plain `{}` causes `headers?.get is not a function`
- Mock `@clack/prompts` in CLI tests when testing code paths that call interactive prompts (select, confirm, text) to avoid hanging tests
- `import.meta.dirname` works in vitest for resolving paths relative to the source file
---

## 2026-02-16 - Story 3.1: Viability assessment
- What was implemented:
  - Added `@anthropic-ai/sdk` dependency (v0.74.0) for Claude API integration
  - Created `src/shared/claude-client.ts` — shared Claude API client with `sendMessage()`, `createAnthropicClient()`, and `isRetryableApiError()` (rate limit + server errors are retryable)
  - Created `prompts/viability/system.md` — BMAD-style prompt template for viability assessment (feasibility, market fit, technical complexity)
  - Created `src/planning/viability.ts` — viability assessment module with profile context formatting, recommendation extraction (PROCEED/CONCERNS/RECONSIDER), and file persistence to `.boop/planning/viability.md`
  - Updated `src/cli/program.ts` — `boop <idea>` now runs viability assessment, displays results, and prompts user to proceed/revise/stop
  - Created `src/shared/claude-client.test.ts` — 7 tests for API error classification
  - Created `src/planning/viability.test.ts` — 20 tests covering prompt loading, profile formatting, recommendation extraction, file saving, and mocked API calls
  - Updated `src/cli/program.test.ts` — added viability and @clack/prompts mocks to prevent real API calls and interactive prompt hangs
- Files changed:
  - NEW: `src/shared/claude-client.ts`, `src/shared/claude-client.test.ts`
  - NEW: `src/planning/viability.ts`, `src/planning/viability.test.ts`
  - NEW: `prompts/viability/system.md`
  - MODIFIED: `package.json`, `pnpm-lock.yaml` (@anthropic-ai/sdk)
  - MODIFIED: `src/shared/index.ts` (re-exports claude-client)
  - MODIFIED: `src/cli/program.ts`, `src/cli/program.test.ts` (viability integration + mocks)
  - FORMATTING: docs/epics.md, src/config/index.ts, src/pipeline/orchestrator.test.ts, src/profile/*.ts, src/shared/*.ts (oxfmt)
- **Learnings for future iterations:**
  - vi.mock() factories are hoisted to the top of the file — any variables referenced inside must use `vi.hoisted()` to be available
  - vi.restoreAllMocks() removes mock implementations from vi.mock factories — use mockReset() on individual mocks instead
  - Anthropic SDK APIError needs a Headers object, not a plain object
  - CLI tests that trigger startPipeline need @clack/prompts mocked to avoid interactive prompt hangs
  - The retry utility integrates cleanly with isRetryableApiError for Claude API fault tolerance
  - prompts/ directory is not in tsconfig include — markdown files are loaded at runtime via fs.readFileSync
---

## 2026-02-16 - Story 3.2: PRD generation
- What was implemented:
  - Created `prompts/prd/system.md` — BMAD-style prompt template for PRD generation (executive summary, functional/non-functional requirements, MVP scope, success criteria, risks)
  - Created `src/planning/prd.ts` — PRD generation module with `generatePrd()`, `buildUserMessage()`, `loadSystemPrompt()`, `savePrd()`, `loadViabilityAssessment()`. Chains viability output as input context. Uses 8192 maxTokens (higher than viability's 4096) for longer PRD output.
  - Created `src/planning/prd.test.ts` — 16 tests covering prompt loading, user message building (profile + idea + viability), file saving, viability loading, and mocked API calls
  - Updated `src/cli/program.ts` — after viability proceeds (user selects "proceed" or autonomous mode), now calls `runPrdPhase()` which generates and saves the PRD
  - Updated `src/cli/program.test.ts` — added `mockGeneratePrd` mock to prevent real API calls during CLI tests
- Files changed:
  - NEW: `prompts/prd/system.md`
  - NEW: `src/planning/prd.ts`, `src/planning/prd.test.ts`
  - MODIFIED: `src/cli/program.ts` (PRD phase integration after viability)
  - MODIFIED: `src/cli/program.test.ts` (PRD mock setup)
  - MODIFIED: `scripts/ralph/prd.json` (3.2 passes: true)
- **Learnings for future iterations:**
  - Reuse `formatProfileContext()` from viability.ts — no need to duplicate profile formatting
  - Each planning phase chains the prior phase's output as input context (viability → PRD → architecture → stories)
  - PRD needs higher maxTokens (8192) than viability (4096) since the output is longer
  - The `loadViabilityAssessment()` helper reads from `.boop/planning/viability.md` — useful for chaining phases that don't run in the same session
---

## 2026-02-16 - Story 3.3: Architecture generation
- What was implemented:
  - Created `prompts/architecture/system.md` — BMAD-style prompt template for architecture generation (tech stack, architecture decisions, escalated decisions, deployment, security). Key design: auto-decide from profile, only escalate genuinely novel choices.
  - Created `src/planning/architecture.ts` — architecture generation module with `generateArchitecture()`, `buildUserMessage()`, `loadSystemPrompt()`, `saveArchitecture()`, `loadPrd()`. Chains PRD output as input context. Uses 8192 maxTokens (same as PRD).
  - Created `src/planning/architecture.test.ts` — 16 tests covering prompt loading, user message building (profile + idea + PRD), file saving, PRD loading, and mocked API calls
  - Updated `src/cli/program.ts` — after PRD generation completes, now calls `runArchitecturePhase()` which generates and saves the architecture document. Added import for `generateArchitecture`.
  - Updated `src/cli/program.test.ts` — added `mockGenerateArchitecture` mock to prevent real API calls during CLI tests
- Files changed:
  - NEW: `prompts/architecture/system.md`
  - NEW: `src/planning/architecture.ts`, `src/planning/architecture.test.ts`
  - MODIFIED: `src/cli/program.ts` (architecture phase integration after PRD)
  - MODIFIED: `src/cli/program.test.ts` (architecture mock setup)
  - MODIFIED: `scripts/ralph/prd.json` (3.3 passes: true)
- **Learnings for future iterations:**
  - Pattern is very consistent across planning phases: loadSystemPrompt → buildUserMessage → sendMessage → save. Each new phase is a straightforward copy of the prior with different input chaining.
  - Architecture uses same maxTokens (8192) as PRD — the output is similarly detailed
  - `loadPrd()` helper reads from `.boop/planning/prd.md` — mirrors `loadViabilityAssessment()` for cross-session chaining
  - CLI pipeline chain: viability → PRD → architecture. Each `run*Phase` function calls the next at the end.
---
