# Ralph Progress Log
Started: Mon Feb 16 19:15:19 CST 2026
---

## Codebase Patterns

### Review Agent Pattern
- Each review agent is a function: `(context: ReviewContext) => Promise<AgentResult>`
- Refactoring agent has extra param: `(context, findings) => Promise<AgentResult>`
- AgentResult includes: agent name, success flag, markdown report, findings array, blockingIssues array
- FindingSeverity: critical | high | medium | low | info
- critical/high findings block epic advancement
- Review artifacts saved to `.boop/reviews/epic-N/` with specific filenames per agent
- QA smoke test results go in a subdirectory: `.boop/reviews/epic-N/qa-smoke-test/`

### Code Review Agent Pattern
- Factory function: `createCodeReviewer(options)` returns `ReviewAgentFn`
- Uses git diff to find changed files, reads diffs + content
- Batches files (50k chars max) for API calls
- Claude outputs structured JSON finding lines, parsed by `parseFindings()`
- Source files use relative imports (`../shared/`), NOT `#boop/` alias

### Review Pipeline Sequence
1. Parallel: code-reviewer + gap-analyst + tech-debt-auditor (Promise.all)
2. refactoring-agent (receives combined findings from step 1)
3. test-hardener
4. test-suite run (if fails, pipeline stops — skips security + QA)
5. security-scanner
6. qa-smoke-test

---

## 2026-02-16 19:20 - Story 5.1
- Implemented review team orchestrator at src/review/team-orchestrator.ts
- Files created:
  - src/review/team-orchestrator.ts (orchestrator + types + error class)
  - src/review/team-orchestrator.test.ts (35 tests)
- **Learnings for future iterations:**
  - Agent functions are injected via options for testability — no vi.mock needed
  - ReviewPhaseError follows same pattern as PlanningPhaseError
  - Test suite failure is an early-exit condition — stops before security/QA
  - Blocking conditions: unresolved gaps, critical/high vulns, QA crashes, test failures
  - vi.fn<FnType>() typing works well for typed mock agents
---

## 2026-02-16 19:25 - Story 5.2
- Implemented code review agent at src/review/code-reviewer.ts
- Files created:
  - src/review/code-reviewer.ts (code reviewer agent with git diff + Claude review)
  - src/review/code-reviewer.test.ts (26 tests)
- **Architecture:**
  - `createCodeReviewer(options)` factory returns a `ReviewAgentFn`
  - Uses `git diff --name-only --diff-filter=ACMR` to find changed files
  - Batches files by size (50k chars) for API calls to avoid token limits
  - Sends diffs + content to Claude with structured JSON output format
  - `parseFindings()` parses JSON lines from response
  - critical/high findings become blockingIssues
  - Falls back to `git ls-files` if diff against base branch fails
- **Learnings for future iterations:**
  - Source files must use relative imports (`../shared/`), NOT `#boop/` alias — alias only works in vitest
  - When mocking `node:child_process.execFile` with promisify, must also mock `node:util.promisify`
  - Git diff args include `--diff-filter=ACMR` at index 2, so matching by branch name needs `args.includes()` not positional check
  - Truncation helper needed for large files to stay within API token limits
---
