# Ralph Progress Log
Started: Mon Feb 16 19:15:19 CST 2026
---

## Codebase Patterns

### Review Agent Pattern
- Each review agent is a function: `(context: ReviewContext) => Promise<AgentResult>`
- Refactoring agent has extra param: `(context, findings) => Promise<AgentResult>`
- AgentResult includes: agent name, success flag, markdown report, findings array, blockingIssues array
- FindingSeverity: critical | high | medium | low | info
- critical/high findings block epic advancement
- Review artifacts saved to `.boop/reviews/epic-N/` with specific filenames per agent
- QA smoke test results go in a subdirectory: `.boop/reviews/epic-N/qa-smoke-test/`

### Code Review Agent Pattern
- Factory function: `createCodeReviewer(options)` returns `ReviewAgentFn`
- Uses git diff to find changed files, reads diffs + content
- Batches files (50k chars max) for API calls
- Claude outputs structured JSON finding lines, parsed by `parseFindings()`
- Source files use relative imports (`../shared/`), NOT `#boop/` alias

### Gap Analyst Agent Pattern
- Factory function: `createGapAnalyst(options)` returns `ReviewAgentFn`
- Reads PRD from `.boop/prd.json`, extracts stories + acceptance criteria
- Scans source files for placeholder patterns (TODO, FIXME, mock, stub, etc.)
- Sends criteria + code to Claude, parses `{storyId, criterion, status, evidence}` JSON lines
- Gaps are high severity + blocking; placeholder matches are medium severity
- Uses `\bmock` (no trailing `\b`) to catch prefixed mock variables like `mockData`

### Tech Debt Auditor Pattern
- Factory function: `createTechDebtAuditor(options)` returns `ReviewAgentFn`
- Collects source files recursively from `src/` (same skip dirs as gap-analyst)
- Sends full file contents to Claude for tech debt analysis (duplication, coupling, naming, unused code)
- Uses same JSON-line parsing as code-reviewer (`parseFindings()`)
- critical/high findings become blockingIssues

### Refactoring Agent Pattern
- Factory function: `createRefactoringAgent(options)` returns `RefactoringAgentFn`
- Receives combined findings from parallel phase (code-reviewer + gap-analyst + tech-debt-auditor)
- Reads only affected files referenced in findings (not entire codebase)
- Groups findings by severity (critical first) in prompt
- Uses same JSON-line parsing for fix suggestions
- Commits should use format: `refactor: Epic N review - [description]`

### Test Hardener Agent Pattern
- Factory function: `createTestHardener(options)` returns `ReviewAgentFn`
- Collects files from both `src/` and `test/` directories
- `categorizeFiles()` separates source files from test files (.test., .spec., test/ dir, __tests__/ dir)
- `findUntestedFiles()` matches source file basenames against test file basenames
- Prioritizes untested files first in API payload
- Includes existing test files for context (limited to 10)
- `isTestFile()` checks basename patterns AND directory patterns (handles both `test/` and `/test/`)
- Uses same parseFindings/extractSummary/report-generation pattern as other agents

### Security Scanner Agent Pattern
- Factory function: `createSecurityScanner(options)` returns `ReviewAgentFn`
- Two-pronged: SAST via Claude SDK + dependency audit via pnpm/npm audit (run in parallel)
- `runDependencyAudit()` tries pnpm then npm; handles non-zero exit (audit exits non-zero when vulns found)
- `parseAuditOutput()` handles npm format (metadata.vulnerabilities) and pnpm format (advisories-based)
- Dependency severity "moderate" maps to "medium" in ReviewFinding schema
- `auditFn` option injected for testability — avoids child_process mocking
- SAST prompt covers OWASP-style vulns: injection, XSS, path traversal, hardcoded secrets, etc.
- Combined findings from both SAST + audit; critical/high from either are blocking
- Report has two sections: SAST Analysis + Dependency Audit (with severity table)
- SKIP_DIRS includes `test` (unlike test-hardener) — only scans production code

### QA Smoke Test Agent Pattern
- Factory function: `createQaSmokeTest(options)` returns `ReviewAgentFn`
- Three-phase: start dev server → test routes in headless Playwright → generate report
- Route discovery: Next.js pages/ dir, Next.js app/ dir (supports route groups), static index.html, fallback to ["/"]
- `discoverRoutes()` handles both pages/ and src/pages/ paths, skips _app, _document, api/, dynamic [segments]
- `detectDevCommand()` checks package.json scripts for dev, start, serve (in priority order)
- `startDevServer()` spawns process, polls with fetch until server responds (configurable timeout)
- `testRoutes()` opens Playwright browser, visits each route, collects console errors + page errors + screenshots
- PlaywrightBrowserHandle/PlaywrightPageHandle abstractions enable testing without real Playwright
- Route failures: page errors → critical severity, console errors/4xx → high severity
- Dev server kill() is always called (in finally block) — even if browser testing throws
- Screenshots named by route: "/" → "index.png", "/about" → "about.png", "/blog/posts" → "blog_posts.png"
- All injectable: startServer, launchBrowser, discoverRoutesFn, fetchFn — no mocking needed in tests

### Review Pipeline Sequence
1. Parallel: code-reviewer + gap-analyst + tech-debt-auditor (Promise.all)
2. refactoring-agent (receives combined findings from step 1)
3. test-hardener
4. test-suite run (if fails, pipeline stops — skips security + QA)
5. security-scanner
6. qa-smoke-test

### Epic Sign-Off Pattern
- `generateEpicSummary()` creates markdown summary from ReviewPhaseResult — saved to `.boop/reviews/epic-N/summary.md`
- `runEpicSignOff()` loop: generate summary → prompt user → on rejection run fix cycle → regenerate → re-prompt
- `runFixCycle()` runs refactoring → test-hardener → test-suite → security → QA (subset of full pipeline)
- User feedback injected as high-severity finding for refactoring agent
- Autonomous mode (`--autonomous`) auto-approves without prompting
- `maxRejectionCycles` (default 3) prevents infinite loops
- All agents injectable via `FixCycleAgents` — same testability pattern as team-orchestrator
- Fix cycle stops early on test failure (skips security + QA) — same as full pipeline

---

## 2026-02-16 19:20 - Story 5.1
- Implemented review team orchestrator at src/review/team-orchestrator.ts
- Files created:
  - src/review/team-orchestrator.ts (orchestrator + types + error class)
  - src/review/team-orchestrator.test.ts (35 tests)
- **Learnings for future iterations:**
  - Agent functions are injected via options for testability — no vi.mock needed
  - ReviewPhaseError follows same pattern as PlanningPhaseError
  - Test suite failure is an early-exit condition — stops before security/QA
  - Blocking conditions: unresolved gaps, critical/high vulns, QA crashes, test failures
  - vi.fn<FnType>() typing works well for typed mock agents
---

## 2026-02-16 19:25 - Story 5.2
- Implemented code review agent at src/review/code-reviewer.ts
- Files created:
  - src/review/code-reviewer.ts (code reviewer agent with git diff + Claude review)
  - src/review/code-reviewer.test.ts (26 tests)
- **Architecture:**
  - `createCodeReviewer(options)` factory returns a `ReviewAgentFn`
  - Uses `git diff --name-only --diff-filter=ACMR` to find changed files
  - Batches files by size (50k chars) for API calls to avoid token limits
  - Sends diffs + content to Claude with structured JSON output format
  - `parseFindings()` parses JSON lines from response
  - critical/high findings become blockingIssues
  - Falls back to `git ls-files` if diff against base branch fails
- **Learnings for future iterations:**
  - Source files must use relative imports (`../shared/`), NOT `#boop/` alias — alias only works in vitest
  - When mocking `node:child_process.execFile` with promisify, must also mock `node:util.promisify`
  - Git diff args include `--diff-filter=ACMR` at index 2, so matching by branch name needs `args.includes()` not positional check
  - Truncation helper needed for large files to stay within API token limits
---

## 2026-02-16 19:30 - Story 5.3
- Implemented gap analysis agent at src/review/gap-analyst.ts
- Files created:
  - src/review/gap-analyst.ts (gap analyst agent with PRD cross-reference + placeholder scan)
  - src/review/gap-analyst.test.ts (37 tests)
- **Architecture:**
  - `createGapAnalyst(options)` factory returns a `ReviewAgentFn`
  - Reads stories from `.boop/prd.json` — extracts acceptance criteria
  - Recursively collects source files from `src/` (skips node_modules, .git, dist, test, .boop)
  - Scans production code for placeholder patterns: TODO, FIXME, HACK, stub, fake, mock, placeholder, dummy, sample, hardcoded, not implemented
  - Sends criteria + source code to Claude for intelligent gap verification
  - Claude outputs structured JSON: `{storyId, criterion, status: verified|gap, evidence}`
  - `parseCriterionResults()` parses JSON lines from response
  - Gaps become high-severity findings + blocking issues
  - Placeholder matches become medium-severity findings
  - Requests 8192 maxTokens (more than default 4096) for detailed analysis
- **Learnings for future iterations:**
  - `\bmock\b` regex won't match `mockData` — use `\bmock` (no trailing boundary) to catch prefixed mock variables
  - `readPrdStories()` handles missing/invalid PRD gracefully — returns empty array
  - `collectSourceFiles()` uses `fs.readdirSync({ withFileTypes: true })` for efficient recursive traversal
  - `maxFilesForApi` and `maxTotalChars` limits prevent API token overflow on large codebases
  - Test pattern: write PRD + source files to tmpDir, mock sendMessage, verify message content + result structure
---

## 2026-02-16 19:35 - Story 5.4
- Implemented tech debt auditor at src/review/tech-debt-auditor.ts
- Implemented refactoring agent at src/review/refactoring-agent.ts
- Files created:
  - src/review/tech-debt-auditor.ts (tech debt auditor agent — scans codebase via Claude SDK)
  - src/review/tech-debt-auditor.test.ts (25 tests)
  - src/review/refactoring-agent.ts (refactoring agent — takes combined findings, suggests fixes via Claude SDK)
  - src/review/refactoring-agent.test.ts (24 tests)
- **Architecture:**
  - `createTechDebtAuditor(options)` factory returns `ReviewAgentFn` — runs in parallel with code-reviewer and gap-analyst
  - Collects source files recursively, sends to Claude for analysis (duplication, coupling, naming, unused code)
  - `createRefactoringAgent(options)` factory returns `RefactoringAgentFn` — runs AFTER parallel phase
  - Receives combined findings, reads affected files, sends to Claude for fix suggestions
  - Groups findings by severity (critical first) in the prompt for prioritized fixing
  - Both agents use same JSON-line parsing pattern as code-reviewer/gap-analyst
  - Both request 8192 maxTokens for detailed analysis
- **Learnings for future iterations:**
  - `getAffectedFiles()` deduplicates file paths from findings — prevents sending same file content multiple times
  - Refactoring agent only reads files referenced in findings (not entire codebase) — more focused API calls
  - SCAN_EXTENSIONS filter applied to affected files prevents reading non-code files (README.md, etc.)
  - Both agents share the same parseFindings/extractSummary pattern — potential future extraction to shared module
  - Test helper `makeFindings()` simplifies creating test finding arrays with defaults
---

## 2026-02-16 19:37 - Story 5.5
- Implemented test hardening agent at src/review/test-hardener.ts
- Files created:
  - src/review/test-hardener.ts (test hardener agent — coverage gap analysis via Claude SDK)
  - src/review/test-hardener.test.ts (34 tests)
- **Architecture:**
  - `createTestHardener(options)` factory returns a `ReviewAgentFn`
  - Collects files from both `src/` and `test/` directories using `collectFiles()`
  - `categorizeFiles()` separates source from test files using basename + directory patterns
  - `findUntestedFiles()` identifies source files without corresponding .test. or .spec. files
  - Prioritizes untested files in API payload for targeted analysis
  - Includes up to 10 existing test files for context (so Claude understands test patterns)
  - Uses same JSON-line parsing (parseFindings) and report generation pattern as other agents
  - Requests 8192 maxTokens for detailed analysis
- **Learnings for future iterations:**
  - `isTestFile()` must handle relative paths starting with `test/` (no leading slash) — not just `/test/`
  - Also needs `startsWith("__tests__/")` for the same reason
  - Windows path compat: normalize backslashes before pattern matching
  - SKIP_DIRS for test-hardener does NOT include `test` (unlike gap-analyst/tech-debt) — we WANT test files
  - `findUntestedFiles()` does basename matching which works for colocated and separated test dirs
---

## 2026-02-16 19:41 - Story 5.6
- Implemented security scanner agent at src/review/security-scanner.ts
- Files created:
  - src/review/security-scanner.ts (security scanner agent — SAST via Claude SDK + dependency audit via pnpm/npm audit)
  - src/review/security-scanner.test.ts (32 tests)
- **Architecture:**
  - `createSecurityScanner(options)` factory returns a `ReviewAgentFn`
  - Two-pronged approach: SAST via Claude SDK + dependency audit via pnpm/npm audit
  - SAST and dependency audit run in parallel (Promise concurrency)
  - Collects source files from `src/` (skips test/, node_modules, .git, dist, coverage, .boop)
  - Claude analyzes code for OWASP-style vulnerabilities (injection, XSS, path traversal, hardcoded secrets, etc.)
  - `runDependencyAudit()` tries pnpm first, falls back to npm — handles non-zero exit (audit exits non-zero when vulns found)
  - `parseAuditOutput()` handles both npm format (metadata.vulnerabilities) and pnpm format (advisories-based)
  - Dependency findings converted to ReviewFindings: critical→critical, high→high, moderate→medium, low→low
  - Combined SAST + audit findings; critical/high from either source are blocking
  - Report has two sections: SAST Analysis + Dependency Audit (with severity table)
  - `auditFn` option allows injecting mock audit function for testing (no child_process mocking needed)
  - Uses same parseFindings/extractSummary/report-generation pattern as other agents
  - Requests 8192 maxTokens for detailed SAST analysis
- **Learnings for future iterations:**
  - pnpm/npm audit exits non-zero when vulnerabilities exist — must catch error and extract stdout
  - Injectable `auditFn` avoids complex child_process mocking in tests
  - SKIP_DIRS includes `test` (unlike test-hardener) — SAST only scans production code
  - Dependency audit severity "moderate" maps to "medium" in ReviewFinding (npm uses "moderate", our schema uses "medium")
---

## 2026-02-16 19:46 - Story 5.7
- Implemented browser QA smoke test agent at src/review/qa-smoke-test.ts
- Files created:
  - src/review/qa-smoke-test.ts (QA smoke test agent — Playwright-based route testing)
  - src/review/qa-smoke-test.test.ts (41 tests)
- **Architecture:**
  - `createQaSmokeTest(options)` factory returns a `ReviewAgentFn`
  - Three-phase approach: start dev server → test routes with headless Playwright → generate report
  - Route discovery: Next.js pages/, Next.js app/ (with route groups), src/pages/, src/app/, static fallback
  - `detectDevCommand()` reads package.json scripts for dev/start/serve commands
  - `startDevServer()` spawns process, polls with fetch until ready (configurable timeout + port)
  - `testRoutes()` launches headless Chromium, visits each route, captures console errors, page errors, screenshots
  - `PlaywrightBrowserHandle` and `PlaywrightPageHandle` interfaces abstract Playwright for testability
  - All dependencies injectable: startServer, launchBrowser, discoverRoutesFn, fetchFn
  - Server always killed in finally block even if browser testing fails
  - Severity: page crashes → critical, console errors/HTTP errors → high
  - Report includes pass/fail per route, console errors, page errors, screenshot references
  - Results saved to `.boop/reviews/epic-N/qa-smoke-test/results.md` + screenshots
- **Learnings for future iterations:**
  - Playwright abstractions (BrowserHandle/PageHandle) make testing trivial — no vi.mock needed
  - Next.js route groups `(marketing)` recurse without adding to path prefix
  - Screenshot naming: "/" → "index.png", strip leading underscore from sanitized names
  - `startDevServer` needs PORT env var set + timeout polling — not just spawn and hope
  - Mock page pattern: store event handlers in closures, fire them during goto() for deterministic testing
  - 3xx status codes treated as success (redirects are not errors)
---

## 2026-02-16 19:50 - Story 5.8
- Implemented epic summary generation and sign-off gate at src/pipeline/epic-loop.ts
- Files created:
  - src/pipeline/epic-loop.ts (epic summary + sign-off gate + fix cycle)
  - src/pipeline/epic-loop.test.ts (28 tests)
- **Architecture:**
  - `generateEpicSummary(projectDir, epicNumber, reviewResult)` — generates markdown summary from ReviewPhaseResult
  - Summary includes: all agent results (code review, gap analysis, tech debt, refactoring, test hardening, security, QA), blocking issues, findings severity tables, QA screenshots, overall findings count
  - Summary saved to `.boop/reviews/epic-N/summary.md`
  - `runEpicSignOff(options)` — sign-off loop: generate summary → prompt user → on rejection run fix cycle → regenerate → re-prompt
  - `runFixCycle(context, feedback, previousFindings, agents)` — refactoring → test-hardener → test-suite → security → QA subset
  - User feedback injected as a high-severity finding for the refactoring agent
  - Autonomous mode auto-approves (no prompt)
  - No prompt function provided → auto-approve (for non-interactive contexts)
  - `maxRejectionCycles` (default 3) caps the rejection/fix loop
  - `SignOffPromptFn` and `FixCycleAgents` injected for testability
- **Learnings for future iterations:**
  - All agent types imported from team-orchestrator (ReviewAgentFn, RefactoringAgentFn, etc.) — no new type definitions needed
  - Fix cycle is a subset of the full review pipeline (starts at refactoring, skips parallel phase)
  - User feedback becomes a high-severity finding — lets the refactoring agent treat it with the same priority as code issues
  - Screenshot discovery reads .png files from QA dir — handles missing dir gracefully
  - Test suite failure in fix cycle stops early (no security/QA on broken code) — same pattern as team-orchestrator
---
